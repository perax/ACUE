---
title: "Ejercicio 1"
author: "Antonio J. Perán"
date: "December 11, 2017"
output: html_document
---

```{r, echo=FALSE, message=FALSE}
# Carga de paquetes
library(tables)
library(Hmisc)

```

# Introducción

# Descripción del conjunto de datos

```{r, echo=FALSE}
# Carga y manejo de datos
file <- "Telco-Customer-Churn.csv"
df <- read.csv(file = file, header = T, sep = ",", na.strings = "NA")
df <- na.omit(df)

df$SeniorCitizen[df$SeniorCitizen == 0] <- 'No'
df$SeniorCitizen[df$SeniorCitizen == 1] <- 'Yes'
df$SeniorCitizen <- as.factor(df$SeniorCitizen)

indexOfnumericvar <- c(6, 19, 20)

dfcat <- df[ , -indexOfnumericvar]
dfnum <- df[ , c(indexOfnumericvar, 21)]

```

El conjunto de datos consta de `r ncol(df)` variables y `r nrow(df)` observaciones, donde cada observación representa el tipo de contrato firmado de un cliente con la empresa, añadiendo además una variable que informa de si este cliente mantiene o no el contrato firmado. La lista de variables es la siguiente:

* `r names(df)[1]`
* `r names(df)[2]`
* `r names(df)[3]`
* `r names(df)[4]`
* `r names(df)[5]`
* `r names(df)[6]`
* `r names(df)[7]`
* `r names(df)[8]`
* `r names(df)[9]`
* `r names(df)[10]`
* `r names(df)[11]`
* `r names(df)[12]`
* `r names(df)[13]`
* `r names(df)[14]`
* `r names(df)[15]`
* `r names(df)[16]`
* `r names(df)[17]`
* `r names(df)[18]`
* `r names(df)[19]`
* `r names(df)[20]`
* `r names(df)[21]`

La tabla siguiente muestra unos descriptivos de frecuencias de las variables categóricas según la variable `Churn`.

```{r, echo=FALSE}
t <- tabular((gender + SeniorCitizen + Partner + Dependents + PhoneService + 
           MultipleLines + InternetService + OnlineSecurity + 
           OnlineSecurity + OnlineBackup + DeviceProtection + 
           TechSupport + StreamingTV + StreamingMovies + Contract + 
           PaperlessBilling + PaymentMethod) ~ (n=1) + ("%"=Percent())*Format(digits=2)+ Churn*((n=1) + ("%"=Percent(denom = "col"))*Format(digits=2)), dfcat)
t
```

```{r, fig.width=10, fig.height=10}
par(mfrow=c(4,4))
for (i in dfcat[ , -c(1, 18)]) {
  n <- length(levels(i))
  counts <- table(i, dfcat$Churn)
  counts <- prop.table(counts, margin = 2)
  if(n == 2){
    barplot(counts, main=names(i),
    xlab=names(df)[21], col=c("darkblue", "red"),
    legend = rownames(counts), beside=TRUE, ylim = c(0,1)) 
  }
  if(n == 3){
    barplot(counts, main=names(i),
    xlab=names(df)[21], col=c("darkblue", "red", "forestgreen"),
    legend = rownames(counts), beside=TRUE, ylim = c(0,1)) 
  }
  if(n == 4){
    barplot(counts, main=names(i),
    xlab=names(df)[21], col=c("darkblue", "red", "forestgreen", "yellow2"),
    legend = rownames(counts), beside=TRUE, ylim = c(0,1)) 
  }
}
```



Y ahora ser realizan unos contrastes Chi-cuadrado para comprobar si las relaciones que se aprecian en la tabla anterior son estadísticamente significativas o debidas al azar.

```{r}
chisq <- data.frame(chi2statistic = 0, df = 0, p_value = 0, vcramer = 0)

for (i in dfcat[ , -1]) {
  test <- chisq.test(i, dfcat$Churn)
  vcramer <- sqrt(test$statistic/(test$parameter*nrow(dfcat)))
  newrow <- as.numeric(c(test$statistic, test$parameter, test$p.value, vcramer))
  chisq <- rbind(chisq, newrow)
  
}

chisq <- chisq[-1, ]
chisq$p_value <- round(chisq$p_value, 3)
chisq$vcramer <- round(chisq$vcramer, 2)
rownames(chisq) <- names(dfcat[ , -1])

chisq
```




La tabla siguiente muestra unos descriptivos de medias y desviación típica de las variables numéricas según la variable `Churn`.

```{r, message=FALSE}
t <- tabular((tenure + MonthlyCharges + TotalCharges) ~ (n=1) + Churn*(mean*Format(digits=4) + sd*Format(digits=4)), dfnum)
t
```

```{r, fig.width=10, fig.height=10, message=FALSE}
library(dplyr)
data <- df[ , c(6, 19, 21)]
data$tenure <- as.factor(data$tenure)
boxplot(MonthlyCharges~tenure*Churn, data=data)
```

